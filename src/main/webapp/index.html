<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
        <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
        <meta name="google-signin-scope" content="profile email">
        <meta name="google-signin-client_id"
                content="852096843957-2vb1jhobb8t1311kqf2v269chbbmp2km.apps.googleusercontent.com">

        <script src="https://apis.google.com/js/platform.js" async defer></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
                integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
                crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/style.css">

        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <title>TinyGram</title>
</head>

<body class="page">
        <section>
                <nav class="navbar navbar-expand-lg navbar-light shadow-sm bg-white">
                        <div class="container"> <a class="navbar-brand d-flex align-items-center" href="#">

                                        <img src="img/logo_final_lettre.png" width="10%" />

                                        <path
                                                d="M511.981,118.509c-0.135-2.956-1.892-5.726-4.565-7.04l-159.24-79.62c-3.776-1.887-8.363-0.64-10.664,2.898 L229.916,200.282l-55.413-85.891c-0.796-1.235-1.945-2.264-3.259-2.922l-159.24-79.62C6.582,29.138,0,33.218,0,39.268v79.621 c0,4.581,3.712,8.294,8.294,8.294c4.581,0,8.294-3.712,8.294-.294V52.687l142.652,71.326v335.32L16.587,388.008V154.277	c0-4.581-3.712-8.294-8.294-8.294c-4.581,0-8.294,3.712-8.294,8.294v238.857c0,3.142,1.775,6.013,4.585,7.418l159.24,79.62	c5.427,2.714,12.003-1.375,12.003-7.418V318.087l324.17,162.085c5.427,2.714,12.003-1.375,12.003-7.418V118.888	C512,118.76,511.987,118.636,511.981,118.509z M175.827,299.541v-152.5l145.239,225.12L175.827,299.541z M495.413,459.335
                        l-139.34-69.671l108.576-186.993c2.299-3.961,0.952-9.037-3.009-11.337c-3.96-2.298-9.036-0.953-11.337,3.009L344.094,377.258
                        L239.77,215.555L347.383,49.998l144.717,72.359l-26.387,45.446c-2.299,3.961-0.952,9.037,3.009,11.337	c3.958,2.297,9.035,0.953,11.337-3.009l15.354-26.443V459.335z" />

                                        <span class="ml-3 font-weight-bold">TinyGram</span>
                                </a> <button class="navbar-toggler navbar-toggler-right border-0" type="button"
                                        data-toggle="collapse" data-target="#navbar4">
                                        <span class="navbar-toggler-icon"></span>
                                </button>

                                <div class="collapse navbar-collapse" id="navbar4">
                                        <ul class="navbar-nav ml-auto pr-4">
                                                <!-- <li class="nav-item px-md-2"> <a class="nav-link" href="pricing.php">Notifications</a> </li> -->
                                                <li class="nav-item px-md-2"> <a class="nav-link"
                                                                onclick="m.route.set('/profile')">Profile</a> </li>
                                                <form class="form-inline">

                                                        <li class="nav-item px-md-3">

                                                                <span class="algolia-autocomplete"
                                                                        style="position: relative; display: inline-block; direction: ltr;">
                                                                        <input type="search"
                                                                                class="form-control ds-input"
                                                                                id="search-input"
                                                                                placeholder="Search friends..."
                                                                                aria-label="Search for..."
                                                                                autocomplete="off" spellcheck="false"
                                                                                role="combobox" aria-autocomplete="list"
                                                                                aria-expanded="false"
                                                                                aria-owns="algolia-autocomplete-listbox-0"
                                                                                dir="auto"
                                                                                style="position: relative; vertical-align: top;">
                                                                        <pre aria-hidden="true"
                                                                                style="position: absolute; visibility: hidden; white-space: pre; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre>
                                                                        <span class="ds-dropdown-menu" role="listbox"
                                                                                id="algolia-autocomplete-listbox-0"
                                                                                style="position: absolute; top: 100%; z-index: 100; left: 0px; right: auto; display: none;">
                                                                                <div class="ds-dataset-1"></div>
                                                                        </span></span>

                                                        </li>
                                                        <li>
                                                                <button class="btn btn-dark my-2 my-sm-0"
                                                                        onclick="User.searchUser()"
                                                                        type="button">Search</button>
                                                        </li>
                                                </form>

                                                <li class="nav-item px-md-2">
                                                        <a class="btn btn-light" onclick="m.route.set('/createPost')"
                                                                role="button">Create post</a>
                                                </li>
                                        </ul>
                                </div>
                        </div>
                </nav>
        </section>
        <section>
                <div id="page"></div>

        </section>
        <script>

                var Profile = {
                        name: "",
                        email: "",
                        ID: "",
                        url: "",
                        followers: "",
                        followings: "",
                        list: [],
                        view: function () {
                                return m('div', { class: "content-profile-page" }, [
                                        m('div', { class: "profile-user-page card" }, [
                                                m('div', { class: "img-user-profile" }, [
                                                        m("img", { "src": Profile.url }),
                                                ]),
                                                m('div', { class: "user-profile-data" }, [
                                                        m("h1", { class: 'title' }, Profile.name),
                                                        m("p", { class: 'category' }, Profile.email),
                                                ]),
                                                m("ul", { class: 'data-user' }, [
                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Posts"),
                                                                ]),
                                                        ]),

                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Followers"),
                                                                ]),
                                                        ]),

                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Followings"),
                                                                ]),
                                                        ]),
                                                ]),
                                        ]), m("div", m(MyPostView, { profile: Profile }))

                                ])
                        }
                }

                var Home = {

                        view: function () {
                                return m('div', { class: 'container' }, [
                                        m("h1", { class: 'title' }, Profile.name),
                                        m("h4", { class: 'subtitle' }, Profile.email),
                                        m("img", { "src": Profile.url }),
                                        m("div", m(PostsView, { profile: Profile }))
                                ])
                        }
                }


                var UserProfile = {
                        name: "",
                        email: "",
                        ID: "",
                        url: "",
                        followers: "",
                        followings: "",
                        list: [],
                        view: function () {
                                return m('div', { class: "content-profile-page" }, [
                                        m('div', { class: "profile-user-page card" }, [
                                                m('div', { class: "img-user-profile" }, [
                                                        m("img", { "src": UserProfile.url }),
                                                ]),
                                                m("button", {
                                                        onclick: function () {
                                                                User.follow(UserProfile.email)
                                                        }
                                                }, "Follow"),
                                                m('div', { class: "user-profile-data" }, [
                                                        m("h1", { class: 'title' }, UserProfile.name),
                                                        m("p", { class: 'category' }, UserProfile.email),
                                                ]),
                                                m("ul", { class: 'data-user' }, [
                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Posts"),
                                                                ]),
                                                        ]),

                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Followers"),
                                                                ]),
                                                        ]),

                                                        m("li", [
                                                                m("a", [
                                                                        m("strong", "60 "),
                                                                        m("span", "Followings"),
                                                                ]),
                                                        ]),
                                                ]),
                                        ]),
                                ])
                        }
                }

                var PostForm = {
                        url: "",
                        body: "",
                        view: function () {
                                return m("form", {
                                        onsubmit: function (e) {
                                                e.preventDefault()
                                                if (url = "") { url = "https://dummyimage.com/320x200/000/fff&text=" + Date.now() }
                                                if (body = "") { body = "bla bla bla \n" + Date.now() }
                                                MyPost.postMessage()
                                        }
                                },
                                        [
                                                m('div', { class: 'field' }, [
                                                        m("label", { class: 'label' }, "URL"),
                                                        m('div', { class: 'control' }, m("input[type=text]", {
                                                                class: 'input is-rounded',
                                                                placeholder: "Your url",
                                                                oninput: function (e) { PostForm.url = e.target.value }
                                                        })),
                                                        //		         m("img",{"src":this.url}),
                                                ]),
                                                m('div', { class: 'field' }, [
                                                        m("label", { class: 'label' }, "Body"),
                                                        m('div', { class: 'control' }, m("input[type=textarea]", {
                                                                class: 'textarea',
                                                                placeholder: "your text",
                                                                oninput: function (e) { PostForm.body = e.target.value }
                                                        })),
                                                ]),
                                                m('div', { class: 'control' }, m("button[type=submit]", { class: 'button is-link' }, "Post")),
                                        ])
                        }
                }

                var MyPost = {
                        list: [],
                        nextToken: "",
                        loadList: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/user/posts" + '?access_token=' + encodeURIComponent(Profile.ID)
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                MyPost.list = result.items
                                                if ('nextPageToken' in result) {
                                                        MyPost.nextToken = result.nextPageToken
                                                } else {
                                                        MyPost.nextToken = ""
                                                }
                                        })
                        },
                        next: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/user/posts",
                                        params: {
                                                'next': MyPost.nextToken,
                                                'access_token': encodeURIComponent(Profile.ID)
                                        }
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                result.items.map(function (item) { MyPost.list.push(item) })
                                                if ('nextPageToken' in result) {
                                                        MyPost.nextToken = result.nextPageToken
                                                } else {
                                                        MyPost.nextToken = ""
                                                }
                                        })
                        },
                        postMessage: function () {
                                var data = {
                                        'owner': Profile.ID,
                                        'url': CreatePost.url,
                                        'body': CreatePost.body
                                }
                                console.log("post:" + data)
                                return m.request({
                                        method: "POST",
                                        url: "_ah/api/myApi/v1/postMsg" + '?access_token=' + encodeURIComponent(Profile.ID),
                                        params: data,
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                MyPost.loadList()
                                                m.route.set("/profile")
                                        })
                        }
                }

                // Vue de mes posts (cf MyPost)
                var MyPostView = {
                        view: function (vnode) {
                                return m('div', [
                                        m('table', { class: 'table is-striped', "table": "is-striped" }, [
                                                
                                                MyPost.list.map(function (item) {
                                                        return [
                                                            m("tr", [
                                                                    m('th', m('img', { class: 'is-rounded', 'src': item.properties.url  }))
                                                                ]),
                                                                m("tr", [
                                                                    m("td", m("button", {
                                                                        class: 'like', 
                                                                
                                                                        onclick: function (e) {
                                                                                console.log("like:" + item.key.name)
                                                                                Posts.like(item.key.name);

                                                                        }
                                                                    }, "♥"))
                                                                
                                                               ]),
                                                               m("tr", [
                                                                 m('td', {class: "description" }, [
                                                                     m('label', item.properties.body)
                                                                 ]),
                                                               ]),
                                                                m("td", {class: "nblikes" }, [
                                                                    m('label', item.properties.likesC) 
                                                                ]),
                                                                m("td", [
                                                                    m('p', ' ') 
                                                                ]),
                                                                m("td", [
                                                                    m('p', ' ') 
                                                                ]),

                                                        ]
                                                }),
                                          ]),
                                                //              m("div", isError ? "An error occurred" : "Saved"),
                                                m('button', {
                                                        class: 'button_next',
                                                        onclick: function (e) { MyPost.next() }
                                                },
                                                        "Next"),
                                        
                                ])
                        }
                }
                // Timeline
                var Posts = {
                        list: [],
                        nextToken: "",
                        loadList: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/timeline" + '?access_token=' + encodeURIComponent(Profile.ID)
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                Posts.list = result.items
                                                if ('nextPageToken' in result) {
                                                        Posts.nextToken = result.nextPageToken
                                                } else {
                                                        Posts.nextToken = ""
                                                }
                                        })
                        },
                        next: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/timeline",
                                        params: {
                                                'next': Posts.nextToken,
                                                'access_token': encodeURIComponent(Profile.ID)
                                        }
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                result.items.map(function (item) { Posts.list.push(item) })
                                                if ('nextPageToken' in result) {
                                                        Posts.nextToken = result.nextPageToken
                                                } else {
                                                        Posts.nextToken = ""
                                                }
                                        })
                        },
                        like: function (key) {
                                return m.request({
                                        method: "POST",
                                        url: "_ah/api/myApi/v1/likePost" + '?access_token=' + encodeURIComponent(Profile.ID),
                                        params: {
                                                'key': key
                                        }
                                })
                                        .then(function (result) {
                                                Posts.loadList();
                                                console.log("got:", result)
                                        })
                        }
                }

                // Vue de mes posts (cf MyPost)
                var PostsView = {
                        view: function (vnode) {
                                return m('div', [
                                        m('table', { class: 'table is-striped', "table": "is-striped" }, [
                                                
                                                Posts.list.map(function (item) {
                                                        return [
                                                            m("tr", [
                                                                    m('th', m('img', { class: 'is-rounded', 'src': item.properties.url  }))
                                                                ]),
                                                                m("tr", [
                                                                    m("td", m("button", {
                                                                        class: 'like', 
                                                                
                                                                        onclick: function (e) {
                                                                                console.log("like:" + item.key.name)
                                                                                Posts.like(item.key.name);

                                                                        }
                                                                    }, "♥"))
                                                                
                                                               ]),
                                                               m("tr", [
                                                                 m('td', {class: "description" }, [
                                                                     m('label', item.properties.body)
                                                                 ]),
                                                               ]),
                                                                m("td", {class: "nblikes" }, [
                                                                    m('label', item.properties.likesC) 
                                                                ]),
                                                                m("td", [
                                                                    m('p', ' ') 
                                                                ]),
                                                                m("td", [
                                                                    m('p', ' ') 
                                                                ]),

                                                        ]
                                                }),
                                          ]),
                                                //              m("div", isError ? "An error occurred" : "Saved"),
                                                m('button', {
                                                        class: 'button_next',
                                                        onclick: function (e) { Posts.next() }
                                                },
                                                        "Next"),
                                        
                                ])
                        }
                }
                var CreatePost = {
                        url: "",
                        body: "",
                        view: function () {
                                return m("form", {
                                        onsubmit: function (e) {
                                                e.preventDefault()
                                                if (url = "") { url = "https://dummyimage.com/320x200/000/fff&text=" + Date.now() }
                                                if (body = "") { body = "bla bla bla \n" + Date.now() }
                                                MyPost.postMessage()
                                        }
                                },
                                        [
                                                m('section', { class: 'hero' }, [
                                                        m('div', { class: 'container' }, [
                                                                m('div', { class: 'row' }, [
                                                                        m('div', { class: 'col-lg-6 offset-lg-3' }, [
                                                                                m('div', { class: 'cardbox shadow-lg bg-white' }, [
                                                                                        m('div', { class: 'cardbox-heading' }, [
                                                                                                m('div', { class: 'field panel-block is-horizontal' }, [
                                                                                                        m('div', { class: 'field' }, [
                                                                                                                m("label", { class: 'label' }),
                                                                                                                m('div', { class: 'control' }, m("input[type=textarea]", {
                                                                                                                        class: 'textarea',
                                                                                                                        placeholder: "Write description",
                                                                                                                        oninput: function (e) { CreatePost.body = e.target.value }
                                                                                                                })),
                                                                                                        ]),
                                                                                                        m('div', { class: 'field' }, [
                                                                                                                m("label", { class: 'label' }),
                                                                                                                m('div', { class: 'input' }, m("input[type=text]", {
                                                                                                                        class: 'url',
                                                                                                                        placeholder: "Copy your url",
                                                                                                                        oninput: function (e) { CreatePost.url = e.target.value }
                                                                                                                })),
                                                                                                                //               m("img",{"src":this.url}),
                                                                                                        ]),
                                                                                                        m('div', { class: "col text-center" }, [

                                                                                                                m('div', { class: 'buttonPost' }, m("button[type=submit]", { class: 'btn btn-dark btn-sm' }, "Post")),
                                                                                                        ]),
                                                                                                ]),
                                                                                        ]),
                                                                                ]),
                                                                        ]),
                                                                ]),
                                                        ]),
                                                ]),
                                        ])
                        }
                }


                var User = {

                        searchUser: function () {
                                console.log("sending request.." + document.getElementById("search-input").value)
                                return m.request({

                                        method: "GET",
                                        url: "_ah/api/myApi/v1/user/get" + '?access_token=' + encodeURIComponent(Profile.ID),
                                        params: {
                                                'key': document.getElementById("search-input").value
                                        }
                                })
                                        .then(function (result) {
                                                console.log("results :", result)
                                                var results = result;
                                                if (results = null) {
                                                        m.route.set("/userNotFound")

                                                } else {
                                                    	console.log("results :", results)
                                                        UserProfile.name = result.properties.name
                                                        UserProfile.url = result.properties.url
                                                        UserProfile.email = result.key.name
                                                        UserProfile.followers = result.properties.followers;
                                                        UserProfile.followings = result.properties.followings;
                                                        m.route.set("/userProfile")
                                                }



                                        })
                        },
                        follow: function (key) {

                                return m.request({

                                        method: "GET",
                                        url: "_ah/api/myApi/v1/follow" + '?access_token=' + encodeURIComponent(Profile.ID),
                                        params: {
                                                'key': key
                                        }
                                })
                                        .then(function (result) {
                                                console.log("results :", result)
                                                Profile.followings = result.properties.followings;
                                                Profile.followings = result.properties.followers;

                                        })

                        }

                }

                var Alert = { 
                	    view: function () {
                	    	m('div', { class: 'alert alert-danger'}, [
            	    			m("a","Nous ne trouvons pas l'utilisateur demandé... Réessayez !"),
            	    		])
                	    }
                }
                var Login = {
                        view: function () {
                                return [m('div', { class: 'image' }, [
                                        m("img[src='img/logo_final.png']")
                                ]),
                                m('div', { class: "wrapper fadeInDown" }, [
                                        m('div', { class: "formContent" }, [
                                                m("p", "Welcome"),
                                                m("div", {
                                                        "class": "g-signin2",
                                                        "data-theme": "dark",
                                                        "data-onsuccess": "onSignIn"
                                                }),
                                        ]),
                                        m('div', { class: "formFooter" }),
                                ]),
                                ]
                        }
                }


                function onSignIn(googleUser) {
                        var profile = googleUser.getBasicProfile();
                        Profile.name = profile.getName();
                        Profile.email = profile.getEmail();
                        Profile.ID = googleUser.getAuthResponse().id_token;
                        Profile.url = profile.getImageUrl();
                        createUser();
                        m.route.set("/secret")

                }

                function createUser() {
                        var data = {
                                'email': Profile.email,
                                'name': Profile.name,
                                'url': Profile.url
                        }
                        console.log('name sent ? ', data.name)
                        return m.request({
                                method: "POST",
                                url: "_ah/api/myApi/v1/createUser" + '?access_token=' + encodeURIComponent(Profile.ID),
                                params: data,
                        })
                                .then(function (result) {
                                        console.log("user:", result)
                                })
                }


                m.route(document.getElementById("page"), "/secret", {
                        "/secret": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return Home
                                }
                        },
                        "/login": Login,
                        "/createPost": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return CreatePost
                                }
                        },
                        "/profile": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return Profile
                                }
                        },
                        "/userProfile": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return UserProfile
                                }
                        },
                        "/userNotFound":{
                        		onmatch: function(){
                                    if (Profile.ID == "") { m.route.set("/login") }
                                    else return Alert
                            	}
                        }
                })
        </script>
</body>

</html>