<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
        <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
        <meta name="google-signin-scope" content="profile email">
        <meta name="google-signin-client_id"
                content="852096843957-2vb1jhobb8t1311kqf2v269chbbmp2km.apps.googleusercontent.com">

        <script src="https://apis.google.com/js/platform.js" async defer></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
                integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
                crossorigin="anonymous">

        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <title>TinyGram</title>
</head>

<body>

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#">TinyGram</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mr-auto">
                                <li class="nav-item active">
                                        <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                                </li>
                                <li class="nav-item">
                                        <a class="nav-link" href="#">Link</a>
                                </li>
                        </ul>
                        <form class="form-inline my-2 my-lg-0">
                                <input class="form-control mr-sm-2" type="search" placeholder="Search"
                                        aria-label="Search">
                                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                        </form>
                </div>
        </nav>
        <div id="page"></div>
        <script>

                var Profile = {
                        name: "",
                        email: "",
                        ID: "",
                        url: "",
                        nextToken: "",
                        list: [],
                        view: function () {
                                return m('div', { class: 'container' }, [
                                        m("h1", { class: 'title' }, "name:" + Profile.name),
                                        m("h2", { class: 'subtitle' }, "email:" + Profile.email),
                                        m("img", { "src": Profile.url }),
                                        m("button", { class: "button", onclick: function (e) { Profile.loadList() } }, "Msgs"),
                                        m("button", { class: "button", onclick: function (e) { Profile.postMessage() } }, "Post Dummy"),
                                        m("div", m(PostForm)),
                                        m("div", m(PostView, { profile: Profile }))
                                ])
                        },
                        loadList: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/collectionresponse_entity" + '?access_token=' + encodeURIComponent(Profile.ID)
                                })
                                        .then(function (result) {
                                                console.log("load_list:", result)
                                                Profile.list = result.items
                                                if ('nextPageToken' in result) {
                                                        Profile.nextToken = result.nextPageToken
                                                } else {
                                                        Profile.nextToken = ""
                                                }
                                        })
                        },
                        next: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/collectionresponse_entity",
                                        params: {
                                                'next': Profile.nextToken,
                                                'access_token': encodeURIComponent(Profile.ID)
                                        }
                                })
                                        .then(function (result) {
                                                console.log("next:", result)
                                                result.items.map(function (item) { Profile.list.push(item) })
                                                if ('nextPageToken' in result) {
                                                        Profile.nextToken = result.nextPageToken
                                                } else {
                                                        Profile.nextToken = ""
                                                }
                                        })
                        }
                }


                var PostForm = {

                        view: function () {
                                var data = {
                                        'body': '',
                                        'url': ''
                                }
                                return m("form", {
                                        onsubmit: function () {
                                                PostForm.savePost(data)
                                        }

                                }, [
                                        m("label.label", "Body"),
                                        m("input.input[type=text][placeholder=Body]", {
                                                oninput: function (e) { data.body = e.target.value },
                                                value: data.body
                                        }),
                                        m("label.label", "Image"),
                                        m("input.input[type=url][placeholder=Image]", {
                                                oninput: function (e) { data.url = e.target.value },
                                                value: data.url
                                        }),
                                        m("button.button[type=button]", "Save"),
                                ])

                        },
                        savePost: function (post) {
                                console.log("post:" + post)
                                return m.request({
                                        method: "POST",
                                        url: "_ah/api/myApi/v1/postMsg" + '?access_token=' + encodeURIComponent(Profile.ID),
                                        params: data,
                                })
                                        .then(function (result) {
                                                console.log("post_message:", result)

                                        })
                        }

                }


                var PostView = {
                        view: function (vnode) {
                                return m('div', [
                                        m('div', { class: 'subtitle' }, "My Posts"),
                                        m('table', { class: 'table is-striped', "table": "is-striped" }, [
                                                m('tr', [
                                                        m('th', { width: "50px" }, "like"),
                                                        m('th', { width: "50px" }, "del"),
                                                        m('th', { width: "50px" }, "Bodys"),
                                                        m('th', { width: "50px" }, "Urls"),
                                                        m('th', { width: "50px" }, "Like"),
                                                ]),
                                                vnode.attrs.profile.list.map(function (item) {
                                                        return m("tr", [
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("like:" + item.key.id)
                                                                        }
                                                                }, "like")),
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("del:" + item.key.id)
                                                                        }
                                                                }, "del")),
                                                                m('td', m('label', item.properties.body)),
                                                                m('td', m('img', { class: 'is-rounded', 'src': item.properties.url })),
                                                                m('td', m('label', item.properties.likec)),
                                                        ])
                                                }),
                                                //			    m("div", isError ? "An error occurred" : "Saved"),
                                                m('button', {
                                                        class: 'button is-link',
                                                        onclick: function (e) { vnode.attrs.profile.next() }
                                                },
                                                        "Next"),
                                        ])
                                ])
                        }
                }


                var Login = {
                        view: function () {
                                return m('div', { class: 'container' }, [
                                        m("h1", { class: 'title' }, 'Connection'),
                                        m("div", {
                                                "class": "g-signin2",
                                                "data-theme": "dark",
                                                "data-onsuccess": "onSignIn"
                                        }),
                                ])
                        }
                }

                function onSignIn(googleUser) {
                        var profile = googleUser.getBasicProfile();
                        Profile.name = profile.getName();
                        Profile.email = profile.getEmail();
                        Profile.ID = googleUser.getAuthResponse().id_token;
                        Profile.url = profile.getImageUrl();
                        m.route.set("/secret")
                }

                m.route(document.getElementById("page"), "/secret", {
                        "/secret": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return Profile
                                }
                        },
                        "/login": Login
                })
        </script>

</html>