<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
        <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
        <meta name="google-signin-scope" content="profile email">
        <meta name="google-signin-client_id"
                content="852096843957-2vb1jhobb8t1311kqf2v269chbbmp2km.apps.googleusercontent.com">

        <script src="https://apis.google.com/js/platform.js" async defer></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
                integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
                crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/style.css">

        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <title>TinyGram</title>
</head>

<body class="page">

        <nav class="navbar navbar-expand-lg navbar-light shadow-sm bg-white fixed-top">
                <div class="container"> <a class="navbar-brand d-flex align-items-center" href="#">
                
                        <img
                            src="img/logo_final_lettre.png"
                            width="10%"
                        /> 
                        
                        <path d="M511.981,118.509c-0.135-2.956-1.892-5.726-4.565-7.04l-159.24-79.62c-3.776-1.887-8.363-0.64-10.664,2.898 L229.916,200.282l-55.413-85.891c-0.796-1.235-1.945-2.264-3.259-2.922l-159.24-79.62C6.582,29.138,0,33.218,0,39.268v79.621 c0,4.581,3.712,8.294,8.294,8.294c4.581,0,8.294-3.712,8.294-.294V52.687l142.652,71.326v335.32L16.587,388.008V154.277	c0-4.581-3.712-8.294-8.294-8.294c-4.581,0-8.294,3.712-8.294,8.294v238.857c0,3.142,1.775,6.013,4.585,7.418l159.24,79.62	c5.427,2.714,12.003-1.375,12.003-7.418V318.087l324.17,162.085c5.427,2.714,12.003-1.375,12.003-7.418V118.888	C512,118.76,511.987,118.636,511.981,118.509z M175.827,299.541v-152.5l145.239,225.12L175.827,299.541z M495.413,459.335
                        l-139.34-69.671l108.576-186.993c2.299-3.961,0.952-9.037-3.009-11.337c-3.96-2.298-9.036-0.953-11.337,3.009L344.094,377.258
                        L239.77,215.555L347.383,49.998l144.717,72.359l-26.387,45.446c-2.299,3.961-0.952,9.037,3.009,11.337	c3.958,2.297,9.035,0.953,11.337-3.009l15.354-26.443V459.335z" />
        
                        <span class="ml-3 font-weight-bold">TinyGram</span>
                        </a> <button class="navbar-toggler navbar-toggler-right border-0" type="button" data-toggle="collapse" data-target="#navbar4">
                        <span class="navbar-toggler-icon"></span>
                        </button>
                
                        <div class="collapse navbar-collapse" id="navbar4">
                                <ul class="navbar-nav ml-auto pr-4">
                                <li class="nav-item px-md-2 active"> <a class="nav-link" href="features.php">Home</a> </li>
                                <!-- <li class="nav-item px-md-2"> <a class="nav-link" href="pricing.php">Notifications</a> </li> -->
                                <li class="nav-item px-md-2"> <a class="nav-link" href="about.php">Profile</a> </li>
                                <li class="nav-item px-md-3">
                                        <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input type="search" class="form-control ds-input" id="search-input" placeholder="Search friends..." aria-label="Search for..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" dir="auto" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; left: 0px; right: auto; display: none;"><div class="ds-dataset-1"></div></span></span>
                                </li>
                                <li class="nav-item px-md-2">
                                  <a class="btn btn-dark"  onclick = "m.route.set('/CreatePost')" role="button">Create post</a>
                            </li>
                                </ul>
                        </div>
                </div>
        </nav>
        <div id="page"></div>
        <script>

                var Profile = {
                        name: "",
                        email: "",
                        ID: "",
                        url: "",
                        list: [],
                        view: function () {
                                return m('div', { class: 'container' }, [
                                        m("h1", { class: 'title' }, "name:" + Profile.name),
                                        m("h2", { class: 'subtitle' }, "email:" + Profile.email),
                                        m("img", { "src": Profile.url }),
                                        m("div", m(PostForm)),
                                        m("div", m(MyPostView, { profile: Profile }))
                                ])
                        }
                }


                var PostForm = {
                        url: "",
                        body: "",
                        view: function () {
                                return m("form", {
                                        onsubmit: function (e) {
                                                e.preventDefault()
                                                if (url = "") { url = "https://dummyimage.com/320x200/000/fff&text=" + Date.now() }
                                                if (body = "") { body = "bla bla bla \n" + Date.now() }
                                                MyPost.postMessage()
                                        }
                                },
                                        [
                                                m('div', { class: 'field' }, [
                                                        m("label", { class: 'label' }, "URL"),
                                                        m('div', { class: 'control' }, m("input[type=text]", {
                                                                class: 'input is-rounded',
                                                                placeholder: "Your url",
                                                                oninput: function (e) { PostForm.url = e.target.value }
                                                        })),
                                                        //		         m("img",{"src":this.url}),
                                                ]),
                                                m('div', { class: 'field' }, [
                                                        m("label", { class: 'label' }, "Body"),
                                                        m('div', { class: 'control' }, m("input[type=textarea]", {
                                                                class: 'textarea',
                                                                placeholder: "your text",
                                                                oninput: function (e) { PostForm.body = e.target.value }
                                                        })),
                                                ]),
                                                m('div', { class: 'control' }, m("button[type=submit]", { class: 'button is-link' }, "Post")),
                                        ])
                        }
                }                

                var MyPost = {
                        list: [],
                        nextToken: "",
                        loadList: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/user/posts"+'?access_token=' + encodeURIComponent(Profile.ID)
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                MyPost.list = result.items
                                                if ('nextPageToken' in result) {
                                                        MyPost.nextToken = result.nextPageToken
                                                } else {
                                                        MyPost.nextToken = ""
                                                }
                                        })
                        },
                        next: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/user/posts",
                                        params: {
                                      	  'next':MyPost.nextToken,
                                      	  'access_token': encodeURIComponent(Profile.ID)
                                        }
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                result.items.map(function (item) { MyPost.list.push(item) })
                                                if ('nextPageToken' in result) {
                                                        MyPost.nextToken = result.nextPageToken
                                                } else {
                                                        MyPost.nextToken = ""
                                                }
                                        })
                        },
                        postMessage: function () {
                                var data = {
                                        'owner': Profile.ID,
                                        'url': PostForm.url,
                                        'body': PostForm.body
                                }
                                console.log("post:" + data)
                                return m.request({
                                        method: "POST",
                                        url: "_ah/api/myApi/v1/postMsg"+'?access_token='+encodeURIComponent(Profile.ID),
                                        params: data,
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                MyPost.loadList()
                                        })
                        }
                }

                var MyPostView = {
                        view: function (vnode) {
                                return m('div', [
                                        m('div', { class: 'subtitle' }, "My Posts"),
                                        m('table', { class: 'table is-striped', "table": "is-striped" }, [
                                                m('tr', [
                                                        m('th', { width: "50px" }, "like"),
                                                        m('th', { width: "50px" }, "del"),
                                                        m('th', { width: "50px" }, "Bodys"),
                                                        m('th', { width: "50px" }, "Urls"),
                                                        m('th', { width: "50px" }, "Like"),
                                                ]),
                                                MyPost.list.map(function (item) {
                                                        return m("tr", [
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("like:" + item.key.id)
                                                                                Post.like(item.key.id);

                                                                        }
                                                                }, "like")),
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("del:" + item.key.id)
                                                                        }
                                                                }, "del")),
                                                                m('td', m('label', item.properties.body)),
                                                                m('td', m('img', { class: 'is-rounded', 'src': item.properties.url })),
                                                                m('td', m('label', item.properties.likec)),
                                                        ])
                                                }),
                                                //			    m("div", isError ? "An error occurred" : "Saved"),
                                                m('button', {
                                                        class: 'button is-link',
                                                        onclick: function (e) { MyPost.next() }
                                                },
                                                        "Next"),
                                        ])
                                ])
                        }
                }

// Timeline
                var Posts = {
                        list: [],
                        nextToken: "",
                        loadList: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/timeline"+'?access_token=' + encodeURIComponent(Profile.ID)
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                Post.list = result.items
                                                if ('nextPageToken' in result) {
                                                        Posts.nextToken = result.nextPageToken
                                                } else {
                                                        Posts.nextToken = ""
                                                }
                                        })
                        },
                        next: function () {
                                return m.request({
                                        method: "GET",
                                        url: "_ah/api/myApi/v1/timeline",
                                        params: {
                                      	  'next':Post.nextToken,
                                      	  'access_token': encodeURIComponent(Profile.ID)
                                        }
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                result.items.map(function (item) { Posts.list.push(item) })
                                                if ('nextPageToken' in result) {
                                                        Posts.nextToken = result.nextPageToken
                                                } else {
                                                        Posts.nextToken = ""
                                                }
                                        })
                        },
                        like: function (key) {
                                return m.request({
                                        method: "POST",
                                        url: "_ah/api/myApi/v1/likePost"+'?access_token='+encodeURIComponent(Profile.ID),
                                        params: {
                                                'key':key
                                        }
                                })
                                        .then(function (result) {
                                                console.log("got:", result)
                                                Posts.loadList()
                                        })
                        }
                }

                var PostView = {
                        view: function (vnode) {
                                return m('div', [
                                        m('div', { class: 'subtitle' }, "My Posts"),
                                        m('table', { class: 'table is-striped', "table": "is-striped" }, [
                                                m('tr', [
                                                        m('th', { width: "50px" }, "like"),
                                                        m('th', { width: "50px" }, "del"),
                                                        m('th', { width: "50px" }, "Bodys"),
                                                        m('th', { width: "50px" }, "Urls"),
                                                        m('th', { width: "50px" }, "Like"),
                                                ]),
                                                MyPost.list.map(function (item) {
                                                        return m("tr", [
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("like:" + item.key.id)
                                                                                Posts.like(item.key.id);
                                                                        }
                                                                }, "like")),
                                                                m("td", m("button", {
                                                                        onclick: function (e) {
                                                                                console.log("del:" + item.key.id)
                                                                        }
                                                                }, "del")),
                                                                m('td', m('label', item.properties.body)),
                                                                m('td', m('img', { class: 'is-rounded', 'src': item.properties.url })),
                                                                m('td', m('label', item.properties.likec)),
                                                        ])
                                                }),
                                                //			    m("div", isError ? "An error occurred" : "Saved"),
                                                m('button', {
                                                        class: 'button is-link',
                                                        onclick: function (e) { MyPost.next() }
                                                },
                                                        "Next"),
                                        ])
                                ])
                        }
                }
                var CreatePost = {
                		 url: "",
                         body: "",
                         view: function () {
                                 return m("form", {
                                         onsubmit: function (e) {
                                                 e.preventDefault()
                                                 if (url = "") { url = "https://dummyimage.com/320x200/000/fff&text=" + Date.now() }
                                                 if (body = "") { body = "bla bla bla \n" + Date.now() }
                                                 MyPost.postMessage()
                                         }
                                 },
                                 [
                                 	m('section', { class: 'hero'}, [
 	        							m('div', { class: 'container'}, [
 	        								m('div', { class: 'row' }, [
 	            								m('div', { class: 'col-lg-6 offset-lg-3' }, [
 	                								m('div', { class: 'cardbox shadow-lg bg-white' }, [
 	                    								m('div', { class: 'cardbox-heading' }, [
 													        m('div', {class:'field panel-block is-horizontal'},[
 													        	m('div', { class: 'field' }, [
 					                                                m("label", { class: 'label' }, "Body"),
 					                                                m('div', { class: 'control' }, m("input[type=textarea]", {
 					                                                        class: 'textarea',
 					                                                        placeholder: "your text",
 					                                                        oninput: function (e) { CreatePost.body = e.target.value }
 					                                                })),
 					                                        	]),
 													        	m('div', { class: 'field' }, [
 					                                                m("label", { class: 'label' }, "URL"),
 					                                                m('div', { class: 'control' }, m("input[type=text]", {
 					                                                        class: 'input is-rounded',
 					                                                        placeholder: "Your url",
 					                                                        oninput: function (e) { CreatePost.url = e.target.value }
 					                                                })),
 					                                                //		         m("img",{"src":this.url}),
 														     ]),
 						                                       		 m('div', { class: 'control' }, m("button[type=submit]", { class: 'button' }, "Post")),
 						                                 
 											                ]),
 														]),
 													]),
 												]),
 											]),
 										]),
 								]),
         				   ])
                         }          
             	   }
                


                var Login = {
                        view: function () {
                                return [m('div', { class: 'image' }, [
                        					m("img[src='img/logo_final.png']")
                    					]),                           
                                		m('div', { class: "wrapper fadeInDown" }, [
                                			m('div', { class: "formContent" }, [
                                				m("p", "Welcome"),
                                                m("div", {
                                                "class": "g-signin2",
                                                "data-theme": "dark",
                                                "data-onsuccess": "onSignIn"
                                       			}),
                                       		]),
                                       		m('div', { class: "formFooter" }),
                                       	]),
                                       ]
                        }
                }
   
				
                function onSignIn(googleUser) {
                        var profile = googleUser.getBasicProfile();
                        Profile.name = profile.getName();
                        Profile.email = profile.getEmail();
                        Profile.ID = googleUser.getAuthResponse().id_token;
                        Profile.url = profile.getImageUrl();
                        createUser();
                        m.route.set("/secret")
                        
                }
                
                function createUser(){
                	var data = {
                                        'name': Profile.Name,
                                        'email': Profile.email,
                                        'url' :  Profile.url
                                }
                	return m.request({
                        method: "POST",
                        url: "_ah/api/myApi/v1/user"+'?access_token='+encodeURIComponent(Profile.ID),
                        params : data,
                })
                        .then(function (result) {
                                console.log("user:", result)
                        })
        }	
                

                m.route(document.getElementById("page"), "/secret", {
                        "/secret": {
                                onmatch: function () {
                                        if (Profile.ID == "") { m.route.set("/login") }
                                        else return Profile
                                }
                        },
                        "/login": Login,
                        "/CreatePost": {
                        		onmatch: function() {
                    			  	if (Profile.ID=="") {m.route.set("/login")}
                    				else return CreatePost
                        		}
                        }
                })
        </script>
</body>
</html>